!function(modules){function __webpack_require__(moduleId){if(installedModules[moduleId])return installedModules[moduleId].exports;var module=installedModules[moduleId]={i:moduleId,l:!1,exports:{}};return modules[moduleId].call(module.exports,module,module.exports,__webpack_require__),module.l=!0,module.exports}var installedModules={};__webpack_require__.m=modules,__webpack_require__.c=installedModules,__webpack_require__.i=function(value){return value},__webpack_require__.d=function(exports,name,getter){__webpack_require__.o(exports,name)||Object.defineProperty(exports,name,{configurable:!1,enumerable:!0,get:getter})},__webpack_require__.n=function(module){var getter=module&&module.__esModule?function(){return module.default}:function(){return module};return __webpack_require__.d(getter,"a",getter),getter},__webpack_require__.o=function(object,property){return Object.prototype.hasOwnProperty.call(object,property)},__webpack_require__.p="",__webpack_require__(__webpack_require__.s=0)}([function(module,exports,__webpack_require__){"use strict";function GetFen(){for(var result="",row=0;row<8;row++){0!=row&&(result+="/");for(var empty=0,col=0;col<8;col++){var piece=g_board[(row+2<<4)+col+4];if(0==piece)empty++;else{0!=empty&&(result+=empty),empty=0;var pieceChar=[" ","p","n","b","r","q","k"," "][7&piece];result+=0!=(piece&colorWhite)?pieceChar.toUpperCase():pieceChar}}0!=empty&&(result+=empty)}return result+=g_toMove==colorWhite?" w":" b",result+=" ",0==g_castleRights?result+="-":(0!=(1&g_castleRights)&&(result+="K"),0!=(2&g_castleRights)&&(result+="Q"),0!=(4&g_castleRights)&&(result+="k"),0!=(8&g_castleRights)&&(result+="q")),result+=" ",result+=-1==g_enPassentSquare?"-":FormatSquare(g_enPassentSquare)}function GetMoveSAN(move,validMoves){var from=255&move,to=move>>8&255;if(move&moveflagCastleKing)return"O-O";if(move&moveflagCastleQueen)return"O-O-O";var pieceType=7&g_board[from],result=["","","N","B","R","Q","K",""][pieceType],dupe=!1,rowDiff=!0,colDiff=!0;null==validMoves&&(validMoves=GenerateValidMoves());for(var i=0;i<validMoves.length;i++){var moveFrom=255&validMoves[i],moveTo=validMoves[i]>>8&255;moveFrom!=from&&moveTo==to&&(7&g_board[moveFrom])==pieceType&&(dupe=!0,(240&moveFrom)==(240&from)&&(rowDiff=!1),(15&moveFrom)==(15&from)&&(colDiff=!1))}return dupe?result+=colDiff?FormatSquare(from).charAt(0):rowDiff?FormatSquare(from).charAt(1):FormatSquare(from):pieceType==piecePawn&&(0!=g_board[to]||move&moveflagEPC)&&(result+=FormatSquare(from).charAt(0)),(0!=g_board[to]||move&moveflagEPC)&&(result+="x"),result+=FormatSquare(to),move&moveflagPromotion&&(result+=move&moveflagPromoteBishop?"=B":move&moveflagPromoteKnight?"=N":move&moveflagPromoteQueen?"=Q":"=R"),MakeMove(move),g_inCheck&&(result+=0==GenerateValidMoves().length?"#":"+"),UnmakeMove(move),result}function FormatSquare(square){return["a","b","c","d","e","f","g","h"][(15&square)-4]+(9-(square>>4)+1)}function FormatMove(move){var result=FormatSquare(255&move)+FormatSquare(move>>8&255);return move&moveflagPromotion&&(result+=move&moveflagPromoteBishop?"b":move&moveflagPromoteKnight?"n":move&moveflagPromoteQueen?"q":"r"),result}function GetMoveFromString(moveString){for(var moves=GenerateValidMoves(),i=0;i<moves.length;i++)if(FormatMove(moves[i])==moveString)return moves[i];alert("busted! ->"+moveString+" fen:"+GetFen())}function PVFromHash(move,ply){if(0==ply)return"";if(0==move)return g_inCheck?"checkmate":"stalemate";var pvString=" "+GetMoveSAN(move);MakeMove(move);var hashNode=g_hashTable[g_hashKeyLow&g_hashMask];return null!=hashNode&&hashNode.lock==g_hashKeyHigh&&null!=hashNode.bestMove&&(pvString+=PVFromHash(hashNode.bestMove,ply-1)),UnmakeMove(move),pvString}function Search(finishMoveCallback,maxPly,finishPlyCallback){var alpha=minEval,beta=maxEval;g_globalPly++,g_nodeCount=0,g_qNodeCount=0,g_searchValid=!0;var value,bestMove=0;g_startTime=(new Date).getTime();var i;for(i=1;i<=maxPly&&g_searchValid;i++){var tmp=AlphaBeta(i,0,alpha,beta);if(!g_searchValid)break;value=tmp,value>alpha&&value<beta?(alpha=value-500,beta=value+500,alpha<minEval&&(alpha=minEval),beta>maxEval&&(beta=maxEval)):alpha!=minEval&&(alpha=minEval,beta=maxEval,i--),null!=g_hashTable[g_hashKeyLow&g_hashMask]&&(bestMove=g_hashTable[g_hashKeyLow&g_hashMask].bestMove),null!=finishPlyCallback&&finishPlyCallback(bestMove,value,(new Date).getTime()-g_startTime,i)}null!=finishMoveCallback&&finishMoveCallback(bestMove,value,(new Date).getTime()-g_startTime,i-1)}function Mobility(color){var from,to,mob,pieceIdx,result=0,enemy=8==color?16:8,mobUnit=8==color?g_mobUnit[0]:g_mobUnit[1];for(mob=-3,pieceIdx=(2|color)<<4,from=g_pieceList[pieceIdx++];0!=from;)mob+=mobUnit[g_board[from+31]],mob+=mobUnit[g_board[from+33]],mob+=mobUnit[g_board[from+14]],mob+=mobUnit[g_board[from-14]],mob+=mobUnit[g_board[from-31]],mob+=mobUnit[g_board[from-33]],mob+=mobUnit[g_board[from+18]],mob+=mobUnit[g_board[from-18]],from=g_pieceList[pieceIdx++];for(result+=65*mob,mob=-4,pieceIdx=(3|color)<<4,from=g_pieceList[pieceIdx++];0!=from;){for(to=from-15;0==g_board[to];)to-=15,mob++;if(g_board[to]&enemy&&(mob++,!(g_board[to]&piecePawn))){for(to-=15;0==g_board[to];)to-=15;mob+=mobUnit[g_board[to]]<<2}for(to=from-17;0==g_board[to];)to-=17,mob++;if(g_board[to]&enemy&&(mob++,!(g_board[to]&piecePawn))){for(to-=17;0==g_board[to];)to-=17;mob+=mobUnit[g_board[to]]<<2}for(to=from+15;0==g_board[to];)to+=15,mob++;if(g_board[to]&enemy&&(mob++,!(g_board[to]&piecePawn))){for(to+=15;0==g_board[to];)to+=15;mob+=mobUnit[g_board[to]]<<2}for(to=from+17;0==g_board[to];)to+=17,mob++;if(g_board[to]&enemy&&(mob++,!(g_board[to]&piecePawn))){for(to+=17;0==g_board[to];)to+=17;mob+=mobUnit[g_board[to]]<<2}from=g_pieceList[pieceIdx++]}for(result+=44*mob,mob=-4,pieceIdx=(4|color)<<4,from=g_pieceList[pieceIdx++];0!=from;){for(to=from-1;0==g_board[to];)to--,mob++;for(g_board[to]&enemy&&mob++,to=from+1;0==g_board[to];)to++,mob++;for(g_board[to]&enemy&&mob++,to=from+16;0==g_board[to];)to+=16,mob++;for(g_board[to]&enemy&&mob++,to=from-16;0==g_board[to];)to-=16,mob++;g_board[to]&enemy&&mob++,from=g_pieceList[pieceIdx++]}for(result+=25*mob,mob=-2,pieceIdx=(5|color)<<4,from=g_pieceList[pieceIdx++];0!=from;){for(to=from-15;0==g_board[to];)to-=15,mob++;for(g_board[to]&enemy&&mob++,to=from-17;0==g_board[to];)to-=17,mob++;for(g_board[to]&enemy&&mob++,to=from+15;0==g_board[to];)to+=15,mob++;for(g_board[to]&enemy&&mob++,to=from+17;0==g_board[to];)to+=17,mob++;for(g_board[to]&enemy&&mob++,to=from-1;0==g_board[to];)to--,mob++;for(g_board[to]&enemy&&mob++,to=from+1;0==g_board[to];)to++,mob++;for(g_board[to]&enemy&&mob++,to=from+16;0==g_board[to];)to+=16,mob++;for(g_board[to]&enemy&&mob++,to=from-16;0==g_board[to];)to-=16,mob++;g_board[to]&enemy&&mob++,from=g_pieceList[pieceIdx++]}return result+=22*mob}function Evaluate(){var curEval=g_baseEval,evalAdjust=0;0==g_pieceList[pieceQueen<<4]&&(evalAdjust-=pieceSquareAdj[pieceKing][g_pieceList[(colorWhite|pieceKing)<<4]]),0==g_pieceList[(colorWhite|pieceQueen)<<4]&&(evalAdjust+=pieceSquareAdj[pieceKing][flipTable[g_pieceList[pieceKing<<4]]]),g_pieceCount[pieceBishop]>=2&&(evalAdjust-=500),g_pieceCount[pieceBishop|colorWhite]>=2&&(evalAdjust+=500);var mobility=Mobility(8)-Mobility(0);return 0==g_toMove?(curEval-=mobility,curEval-=evalAdjust):(curEval+=mobility,curEval+=evalAdjust),curEval}function ScoreMove(move){var score,moveTo=move>>8&255,captured=7&g_board[moveTo],piece=g_board[255&move];if(0!=captured){score=(captured<<5)-(7&piece)}else score=historyTable[15&piece][moveTo];return score}function QSearch(alpha,beta,ply){g_qNodeCount++;var realEval=g_inCheck?minEval+1:Evaluate();if(realEval>=beta)return realEval;realEval>alpha&&(alpha=realEval);var moves=new Array,moveScores=new Array,wasInCheck=g_inCheck;if(wasInCheck){GenerateCaptureMoves(moves,null),GenerateAllMoves(moves);for(var i=0;i<moves.length;i++)moveScores[i]=ScoreMove(moves[i])}else{GenerateCaptureMoves(moves,null);for(var i=0;i<moves.length;i++){var captured=7&g_board[moves[i]>>8&255],pieceType=7&g_board[255&moves[i]];moveScores[i]=(captured<<5)-pieceType}}for(var i=0;i<moves.length;i++){for(var bestMove=i,j=moves.length-1;j>i;j--)moveScores[j]>moveScores[bestMove]&&(bestMove=j);var tmpMove=moves[i];moves[i]=moves[bestMove],moves[bestMove]=tmpMove;var tmpScore=moveScores[i];if(moveScores[i]=moveScores[bestMove],moveScores[bestMove]=tmpScore,(wasInCheck||See(moves[i]))&&MakeMove(moves[i])){var value=-QSearch(-beta,-alpha,ply-1);if(UnmakeMove(moves[i]),value>realEval){if(value>=beta)return value;value>alpha&&(alpha=value),realEval=value}}}return realEval}function StoreHash(value,flags,ply,move,depth){value>=maxMateBuffer?value+=depth:value<=minMateBuffer&&(value-=depth),g_hashTable[g_hashKeyLow&g_hashMask]=new HashEntry(g_hashKeyHigh,value,flags,ply,move)}function IsHashMoveValid(hashMove){var from=255&hashMove,to=hashMove>>8&255,ourPiece=g_board[from],pieceType=7&ourPiece;if(pieceType<piecePawn||pieceType>pieceKing)return!1;if(g_toMove!=(8&ourPiece))return!1;if(0!=g_board[to]&&g_toMove==(8&g_board[to]))return!1;if(pieceType==piecePawn){if(hashMove&moveflagEPC)return!1;var dir=to-from;if(g_toMove==colorWhite!=dir<0)return!1;var row=240&to;if((144==row&&!g_toMove||32==row&&g_toMove)!=(hashMove&moveflagPromotion))return!1;if(-16==dir||16==dir)return 0==g_board[to];if(-15==dir||-17==dir||15==dir||17==dir)return 0!=g_board[to];if(-32==dir){if(96!=row)return!1;if(0!=g_board[to])return!1;if(0!=g_board[from-16])return!1}else{if(32!=dir)return!1;if(80!=row)return!1;if(0!=g_board[to])return!1;if(0!=g_board[from+16])return!1}return!0}return!(hashMove>>16)&&IsSquareAttackableFrom(to,from)}function IsRepDraw(){var stop=g_moveCount-1-g_move50;stop=stop<0?0:stop;for(var i=g_moveCount-5;i>=stop;i-=2)if(g_repMoveStack[i]==g_hashKeyLow)return!0;return!1}function MovePicker(hashMove,depth,killer1,killer2){this.hashMove=hashMove,this.depth=depth,this.killer1=killer1,this.killer2=killer2,this.moves=new Array,this.losingCaptures=null,this.moveCount=0,this.atMove=-1,this.moveScores=null,this.stage=0,this.nextMove=function(){if(++this.atMove==this.moveCount){if(this.stage++,1==this.stage&&(null!=this.hashMove&&IsHashMoveValid(hashMove)&&(this.moves[0]=hashMove,this.moveCount=1),1!=this.moveCount&&(this.hashMove=null,this.stage++)),2==this.stage){GenerateCaptureMoves(this.moves,null),this.moveCount=this.moves.length,this.moveScores=new Array(this.moveCount);for(var i=this.atMove;i<this.moveCount;i++){var captured=7&g_board[this.moves[i]>>8&255],pieceType=7&g_board[255&this.moves[i]];this.moveScores[i]=(captured<<5)-pieceType}this.atMove==this.moveCount&&this.stage++}if(3==this.stage&&(IsHashMoveValid(this.killer1)&&this.killer1!=this.hashMove?(this.moves[this.moves.length]=this.killer1,this.moveCount=this.moves.length):(this.killer1=0,this.stage++)),4==this.stage&&(IsHashMoveValid(this.killer2)&&this.killer2!=this.hashMove?(this.moves[this.moves.length]=this.killer2,this.moveCount=this.moves.length):(this.killer2=0,this.stage++)),5==this.stage){GenerateAllMoves(this.moves),this.moveCount=this.moves.length;for(var i=this.atMove;i<this.moveCount;i++)this.moveScores[i]=ScoreMove(this.moves[i]);this.atMove==this.moveCount&&this.stage++}if(6==this.stage){if(null!=this.losingCaptures){for(var i=0;i<this.losingCaptures.length;i++)this.moves[this.moves.length]=this.losingCaptures[i];for(var i=this.atMove;i<this.moveCount;i++)this.moveScores[i]=ScoreMove(this.moves[i]);this.moveCount=this.moves.length}this.atMove==this.moveCount&&this.stage++}if(7==this.stage)return 0}for(var bestMove=this.atMove,j=this.atMove+1;j<this.moveCount;j++)this.moveScores[j]>this.moveScores[bestMove]&&(bestMove=j);if(bestMove!=this.atMove){var tmpMove=this.moves[this.atMove];this.moves[this.atMove]=this.moves[bestMove],this.moves[bestMove]=tmpMove;var tmpScore=this.moveScores[this.atMove];this.moveScores[this.atMove]=this.moveScores[bestMove],this.moveScores[bestMove]=tmpScore}var candidateMove=this.moves[this.atMove];return this.stage>1&&candidateMove==this.hashMove||this.stage>3&&candidateMove==this.killer1||this.stage>4&&candidateMove==this.killer2?this.nextMove():2!=this.stage||See(candidateMove)?this.moves[this.atMove]:(null==this.losingCaptures&&(this.losingCaptures=new Array),this.losingCaptures[this.losingCaptures.length]=candidateMove,this.nextMove())}}function AllCutNode(ply,depth,beta,allowNull){if(ply<=0)return QSearch(beta-1,beta,0);if(127==(127&g_nodeCount)&&(new Date).getTime()-g_startTime>g_timeout)return g_searchValid=!1,beta-1;if(g_nodeCount++,IsRepDraw())return 0;if(minEval+depth>=beta)return beta;if(maxEval-(depth+1)<beta)return beta-1;var hashMove=null,hashNode=g_hashTable[g_hashKeyLow&g_hashMask];if(null!=hashNode&&hashNode.lock==g_hashKeyHigh&&(hashMove=hashNode.bestMove,hashNode.hashDepth>=ply)){var hashValue=hashNode.value;if(hashValue>=maxMateBuffer?hashValue-=depth:hashValue<=minMateBuffer&&(hashValue+=depth),hashNode.flags==hashflagExact)return hashValue;if(hashNode.flags==hashflagAlpha&&hashValue<beta)return hashValue;if(hashNode.flags==hashflagBeta&&hashValue>=beta)return hashValue}if(!g_inCheck&&allowNull&&beta>minMateBuffer&&beta<maxMateBuffer){if(null==hashMove&&ply<4){var razorMargin=2500+200*ply;if(g_baseEval<beta-razorMargin){var razorBeta=beta-razorMargin,v=QSearch(razorBeta-1,razorBeta,0);if(v<razorBeta)return v}}if(ply>1&&g_baseEval>=beta-(ply>=4?2500:0)&&(0!=g_pieceCount[pieceBishop|g_toMove]||0!=g_pieceCount[pieceKnight|g_toMove]||0!=g_pieceCount[pieceRook|g_toMove]||0!=g_pieceCount[pieceQueen|g_toMove])){var r=3+(ply>=5?1:ply/4);g_baseEval-beta>1500&&r++,g_toMove=8-g_toMove,g_baseEval=-g_baseEval,g_hashKeyLow^=g_zobristBlackLow,g_hashKeyHigh^=g_zobristBlackHigh;var value=-AllCutNode(ply-r,depth+1,-(beta-1),!1);if(g_hashKeyLow^=g_zobristBlackLow,g_hashKeyHigh^=g_zobristBlackHigh,g_toMove=8-g_toMove,g_baseEval=-g_baseEval,value>=beta)return beta}}for(var moveMade=!1,realEval=minEval-1,movePicker=new MovePicker(hashMove,depth,g_killers[depth][0],g_killers[depth][1]);;){var currentMove=movePicker.nextMove();if(0==currentMove)break;var plyToSearch=ply-1;if(MakeMove(currentMove)){var value,doFullSearch=!0;if(g_inCheck)plyToSearch++;else{var reduced=plyToSearch-(movePicker.atMove>14?2:1);5==movePicker.stage&&movePicker.atMove>5&&ply>=3&&(value=-AllCutNode(reduced,depth+1,-(beta-1),!0),doFullSearch=value>=beta)}if(doFullSearch&&(value=-AllCutNode(plyToSearch,depth+1,-(beta-1),!0)),moveMade=!0,UnmakeMove(currentMove),!g_searchValid)return beta-1;if(value>realEval){if(value>=beta){var histTo=currentMove>>8&255;if(0==g_board[histTo]){var histPiece=15&g_board[255&currentMove];historyTable[histPiece][histTo]+=ply*ply,historyTable[histPiece][histTo]>32767&&(historyTable[histPiece][histTo]>>=1),g_killers[depth][0]!=currentMove&&(g_killers[depth][1]=g_killers[depth][0],g_killers[depth][0]=currentMove)}return StoreHash(value,hashflagBeta,ply,currentMove,depth),value}realEval=value,hashMove=currentMove}}}return moveMade?(StoreHash(realEval,hashflagAlpha,ply,hashMove,depth),realEval):g_inCheck?minEval+depth:0}function AlphaBeta(ply,depth,alpha,beta){if(ply<=0)return QSearch(alpha,beta,0);if(g_nodeCount++,depth>0&&IsRepDraw())return 0;var oldAlpha=alpha;if(alpha=alpha<minEval+depth?alpha:minEval+depth,beta=beta>maxEval-(depth+1)?beta:maxEval-(depth+1),alpha>=beta)return alpha;var hashMove=null,hashFlag=hashflagAlpha,hashNode=g_hashTable[g_hashKeyLow&g_hashMask];null!=hashNode&&hashNode.lock==g_hashKeyHigh&&(hashMove=hashNode.bestMove);for(var inCheck=g_inCheck,moveMade=!1,realEval=minEval,movePicker=new MovePicker(hashMove,depth,g_killers[depth][0],g_killers[depth][1]);;){var currentMove=movePicker.nextMove();if(0==currentMove)break;var plyToSearch=ply-1;if(MakeMove(currentMove)){g_inCheck&&plyToSearch++;var value;if(moveMade?(value=-AllCutNode(plyToSearch,depth+1,-alpha,!0))>alpha&&(value=-AlphaBeta(plyToSearch,depth+1,-beta,-alpha)):value=-AlphaBeta(plyToSearch,depth+1,-beta,-alpha),moveMade=!0,UnmakeMove(currentMove),!g_searchValid)return alpha;if(value>realEval){if(value>=beta){var histTo=currentMove>>8&255;if(0==g_board[histTo]){var histPiece=15&g_board[255&currentMove];historyTable[histPiece][histTo]+=ply*ply,historyTable[histPiece][histTo]>32767&&(historyTable[histPiece][histTo]>>=1),g_killers[depth][0]!=currentMove&&(g_killers[depth][1]=g_killers[depth][0],g_killers[depth][0]=currentMove)}return StoreHash(value,hashflagBeta,ply,currentMove,depth),value}value>oldAlpha&&(hashFlag=hashflagExact,alpha=value),realEval=value,hashMove=currentMove}}}return moveMade?(StoreHash(realEval,hashFlag,ply,hashMove,depth),realEval):inCheck?minEval+depth:0}function MT(){var N=624,M=397,MAG01=[0,2567483615];this.mt=new Array(N),this.mti=625,this.setSeed=function(){var a=arguments;switch(a.length){case 1:if(a[0].constructor===Number){this.mt[0]=a[0];for(var i=1;i<N;++i){var s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(1812433253*((4294901760&s)>>>16)<<16)+1812433253*(65535&s)+i}return void(this.mti=N)}this.setSeed(19650218);for(var l=a[0].length,i=1,j=0,k=N>l?N:l;0!=k;--k){var s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1664525*((4294901760&s)>>>16)<<16)+1664525*(65535&s))+a[0][j]+j,++i>=N&&(this.mt[0]=this.mt[623],i=1),++j>=l&&(j=0)}for(var k=623;0!=k;--k){var s=this.mt[i-1]^this.mt[i-1]>>>30;this.mt[i]=(this.mt[i]^(1566083941*((4294901760&s)>>>16)<<16)+1566083941*(65535&s))-i,++i>=N&&(this.mt[0]=this.mt[623],i=1)}return void(this.mt[0]=2147483648);default:for(var seeds=new Array,i=0;i<a.length;++i)seeds.push(a[i]);return void this.setSeed(seeds)}},this.setSeed(464384013),this.next=function(bits){if(this.mti>=N){for(var x=0,k=0;k<227;++k)x=2147483648&this.mt[k]|2147483647&this.mt[k+1],this.mt[k]=this.mt[k+M]^x>>>1^MAG01[1&x];for(var k=227;k<623;++k)x=2147483648&this.mt[k]|2147483647&this.mt[k+1],this.mt[k]=this.mt[k+(M-N)]^x>>>1^MAG01[1&x];x=2147483648&this.mt[623]|2147483647&this.mt[0],this.mt[623]=this.mt[396]^x>>>1^MAG01[1&x],this.mti=0}var y=this.mt[this.mti++];return y^=y>>>11,y^=y<<7&2636928640,y^=y<<15&4022730752,(y^=y>>>18)>>>32-bits&4294967295}}function HashEntry(lock,value,flags,hashDepth,bestMove,globalPly){this.lock=lock,this.value=value,this.flags=flags,this.hashDepth=hashDepth,this.bestMove=bestMove}function MakeSquare(row,column){return row+2<<4|column+4}function MakeTable(table){for(var result=new Array(256),i=0;i<256;i++)result[i]=0;for(var row=0;row<8;row++)for(var col=0;col<8;col++)result[MakeSquare(row,col)]=table[8*row+col];return result}function ResetGame(){g_killers=new Array(128);for(var i=0;i<128;i++)g_killers[i]=[0,0];g_hashTable=new Array(g_hashSize);for(var i=0;i<32;i++){historyTable[i]=new Array(256);for(var j=0;j<256;j++)historyTable[i][j]=0}var mt=new MT(464384013);g_zobristLow=new Array(256),g_zobristHigh=new Array(256);for(var i=0;i<256;i++){g_zobristLow[i]=new Array(16),g_zobristHigh[i]=new Array(16);for(var j=0;j<16;j++)g_zobristLow[i][j]=mt.next(32),g_zobristHigh[i][j]=mt.next(32)}g_zobristBlackLow=mt.next(32),g_zobristBlackHigh=mt.next(32);for(var row=0;row<8;row++)for(var col=0;col<8;col++){var square=MakeSquare(row,col);flipTable[square]=MakeSquare(7-row,col)}pieceSquareAdj[piecePawn]=MakeTable(pawnAdj),pieceSquareAdj[pieceKnight]=MakeTable(knightAdj),pieceSquareAdj[pieceBishop]=MakeTable(bishopAdj),pieceSquareAdj[pieceRook]=MakeTable(rookAdj),pieceSquareAdj[pieceQueen]=MakeTable(emptyAdj),pieceSquareAdj[pieceKing]=MakeTable(kingAdj);for(var pieceDeltas=[[],[],g_knightDeltas,g_bishopDeltas,g_rookDeltas,g_queenDeltas,g_queenDeltas],i=0;i<256;i++)g_vectorDelta[i]=new Object,g_vectorDelta[i].delta=0,g_vectorDelta[i].pieceMask=new Array(2),g_vectorDelta[i].pieceMask[0]=0,g_vectorDelta[i].pieceMask[1]=0;for(var row=0;row<128;row+=16)for(var col=0;col<8;col++){var square=row|col,index=square-(square-17)+128;g_vectorDelta[index].pieceMask[colorWhite>>3]|=1<<piecePawn,index=square-(square-15)+128,g_vectorDelta[index].pieceMask[colorWhite>>3]|=1<<piecePawn,index=square-(square+17)+128,g_vectorDelta[index].pieceMask[0]|=1<<piecePawn,index=square-(square+15)+128,g_vectorDelta[index].pieceMask[0]|=1<<piecePawn;for(var i=pieceKnight;i<=pieceKing;i++)for(var dir=0;dir<pieceDeltas[i].length;dir++)for(var target=square+pieceDeltas[i][dir];!(136&target);){index=square-target+128,g_vectorDelta[index].pieceMask[colorWhite>>3]|=1<<i,g_vectorDelta[index].pieceMask[0]|=1<<i;var flip=-1;if(square<target&&(flip=1),(240&square)==(240&target)?g_vectorDelta[index].delta=1*flip:(15&square)==(15&target)?g_vectorDelta[index].delta=16*flip:square%15==target%15?g_vectorDelta[index].delta=15*flip:square%17==target%17&&(g_vectorDelta[index].delta=17*flip),i==pieceKnight){g_vectorDelta[index].delta=pieceDeltas[i][dir];break}if(i==pieceKing)break;target+=pieceDeltas[i][dir]}}InitializeEval(),InitializeFromFen("rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1")}function InitializeEval(){g_mobUnit=new Array(2);for(var i=0;i<2;i++){g_mobUnit[i]=new Array;var enemy=0==i?16:8,friend=0==i?8:16;g_mobUnit[i][0]=1,g_mobUnit[i][128]=0,g_mobUnit[i][enemy|piecePawn]=1,g_mobUnit[i][enemy|pieceBishop]=2,g_mobUnit[i][enemy|pieceKnight]=2,g_mobUnit[i][enemy|pieceRook]=4,g_mobUnit[i][enemy|pieceQueen]=6,g_mobUnit[i][enemy|pieceKing]=6,g_mobUnit[i][friend|piecePawn]=0,g_mobUnit[i][friend|pieceBishop]=0,g_mobUnit[i][friend|pieceKnight]=0,g_mobUnit[i][friend|pieceRook]=0,g_mobUnit[i][friend|pieceQueen]=0,g_mobUnit[i][friend|pieceKing]=0}}function SetHash(){var result=new Object;result.hashKeyLow=0,result.hashKeyHigh=0;for(var i=0;i<256;i++){var piece=g_board[i];24&piece&&(result.hashKeyLow^=g_zobristLow[i][15&piece],result.hashKeyHigh^=g_zobristHigh[i][15&piece])}return g_toMove||(result.hashKeyLow^=g_zobristBlackLow,result.hashKeyHigh^=g_zobristBlackHigh),result}function InitializeFromFen(fen){for(var chunks=fen.split(" "),i=0;i<256;i++)g_board[i]=128;for(var row=0,col=0,pieces=chunks[0],i=0;i<pieces.length;i++){var c=pieces.charAt(i);if("/"==c)row++,col=0;else if(c>="0"&&c<="9")for(var j=0;j<parseInt(c);j++)g_board[MakeSquare(row,col)]=0,col++;else{var isBlack=c>="a"&&c<="z",piece=isBlack?colorBlack:colorWhite;switch(isBlack||(c=pieces.toLowerCase().charAt(i)),c){case"p":piece|=piecePawn;break;case"b":piece|=pieceBishop;break;case"n":piece|=pieceKnight;break;case"r":piece|=pieceRook;break;case"q":piece|=pieceQueen;break;case"k":piece|=pieceKing}g_board[MakeSquare(row,col)]=piece,col++}}InitializePieceList(),g_toMove="w"==chunks[1].charAt(0)?colorWhite:0;var them=8-g_toMove;if(g_castleRights=0,-1!=chunks[2].indexOf("K")){if(g_board[MakeSquare(7,4)]!=(pieceKing|colorWhite)||g_board[MakeSquare(7,7)]!=(pieceRook|colorWhite))return"Invalid FEN: White kingside castling not allowed";g_castleRights|=1}if(-1!=chunks[2].indexOf("Q")){if(g_board[MakeSquare(7,4)]!=(pieceKing|colorWhite)||g_board[MakeSquare(7,0)]!=(pieceRook|colorWhite))return"Invalid FEN: White queenside castling not allowed";g_castleRights|=2}if(-1!=chunks[2].indexOf("k")){if(g_board[MakeSquare(0,4)]!=(pieceKing|colorBlack)||g_board[MakeSquare(0,7)]!=(pieceRook|colorBlack))return"Invalid FEN: Black kingside castling not allowed";g_castleRights|=4}if(-1!=chunks[2].indexOf("q")){if(g_board[MakeSquare(0,4)]!=(pieceKing|colorBlack)||g_board[MakeSquare(0,0)]!=(pieceRook|colorBlack))return"Invalid FEN: Black queenside castling not allowed";g_castleRights|=8}if(g_enPassentSquare=-1,-1==chunks[3].indexOf("-")){var col=chunks[3].charAt(0).charCodeAt()-"a".charCodeAt(),row=8-(chunks[3].charAt(1).charCodeAt()-"0".charCodeAt());g_enPassentSquare=MakeSquare(row,col)}var hashResult=SetHash();g_hashKeyLow=hashResult.hashKeyLow,g_hashKeyHigh=hashResult.hashKeyHigh,g_baseEval=0;for(var i=0;i<256;i++)g_board[i]&colorWhite?(g_baseEval+=pieceSquareAdj[7&g_board[i]][i],g_baseEval+=materialTable[7&g_board[i]]):g_board[i]&colorBlack&&(g_baseEval-=pieceSquareAdj[7&g_board[i]][flipTable[i]],g_baseEval-=materialTable[7&g_board[i]]);return g_toMove||(g_baseEval=-g_baseEval),g_move50=0,g_inCheck=IsSquareAttackable(g_pieceList[(g_toMove|pieceKing)<<4],them),IsSquareAttackable(g_pieceList[(them|pieceKing)<<4],g_toMove)?"Invalid FEN: Can capture king":0==GenerateValidMoves().length?g_inCheck?"Checkmate":"Stalemate":""}function InitializePieceList(){for(var i=0;i<16;i++){g_pieceCount[i]=0;for(var j=0;j<16;j++)g_pieceList[i<<4|j]=0}for(var i=0;i<256;i++)if(g_pieceIndex[i]=0,g_board[i]&(colorWhite|colorBlack)){var piece=15&g_board[i];g_pieceList[piece<<4|g_pieceCount[piece]]=i,g_pieceIndex[i]=g_pieceCount[piece],g_pieceCount[piece]++}}function MakeMove(move){var me=g_toMove>>3,otherColor=8-g_toMove,flags=16711680&move,to=move>>8&255,from=255&move,captured=g_board[to],piece=g_board[from],epcEnd=to;if(flags&moveflagEPC&&(epcEnd=me?to+16:to-16,captured=g_board[epcEnd],g_board[epcEnd]=pieceEmpty),g_moveUndoStack[g_moveCount]=new UndoHistory(g_enPassentSquare,g_castleRights,g_inCheck,g_baseEval,g_hashKeyLow,g_hashKeyHigh,g_move50,captured),g_moveCount++,g_enPassentSquare=-1,flags)if(flags&moveflagCastleKing){if(IsSquareAttackable(from+1,otherColor)||IsSquareAttackable(from+2,otherColor))return g_moveCount--,!1;var rook=g_board[to+1];g_hashKeyLow^=g_zobristLow[to+1][15&rook],g_hashKeyHigh^=g_zobristHigh[to+1][15&rook],g_hashKeyLow^=g_zobristLow[to-1][15&rook],g_hashKeyHigh^=g_zobristHigh[to-1][15&rook],g_board[to-1]=rook,g_board[to+1]=pieceEmpty,g_baseEval-=pieceSquareAdj[7&rook][0==me?flipTable[to+1]:to+1],g_baseEval+=pieceSquareAdj[7&rook][0==me?flipTable[to-1]:to-1];var rookIndex=g_pieceIndex[to+1];g_pieceIndex[to-1]=rookIndex,g_pieceList[(15&rook)<<4|rookIndex]=to-1}else if(flags&moveflagCastleQueen){if(IsSquareAttackable(from-1,otherColor)||IsSquareAttackable(from-2,otherColor))return g_moveCount--,!1;var rook=g_board[to-2];g_hashKeyLow^=g_zobristLow[to-2][15&rook],g_hashKeyHigh^=g_zobristHigh[to-2][15&rook],g_hashKeyLow^=g_zobristLow[to+1][15&rook],g_hashKeyHigh^=g_zobristHigh[to+1][15&rook],g_board[to+1]=rook,g_board[to-2]=pieceEmpty,g_baseEval-=pieceSquareAdj[7&rook][0==me?flipTable[to-2]:to-2],g_baseEval+=pieceSquareAdj[7&rook][0==me?flipTable[to+1]:to+1];var rookIndex=g_pieceIndex[to-2];g_pieceIndex[to+1]=rookIndex,g_pieceList[(15&rook)<<4|rookIndex]=to+1}if(captured){var capturedType=15&captured;g_pieceCount[capturedType]--;var lastPieceSquare=g_pieceList[capturedType<<4|g_pieceCount[capturedType]];g_pieceIndex[lastPieceSquare]=g_pieceIndex[epcEnd],g_pieceList[capturedType<<4|g_pieceIndex[lastPieceSquare]]=lastPieceSquare,g_pieceList[capturedType<<4|g_pieceCount[capturedType]]=0,g_baseEval+=materialTable[7&captured],g_baseEval+=pieceSquareAdj[7&captured][me?flipTable[epcEnd]:epcEnd],g_hashKeyLow^=g_zobristLow[epcEnd][capturedType],g_hashKeyHigh^=g_zobristHigh[epcEnd][capturedType],g_move50=0}else if((7&piece)==piecePawn){var diff=to-from;diff<0&&(diff=-diff),diff>16&&(g_enPassentSquare=me?to+16:to-16),g_move50=0}if(g_hashKeyLow^=g_zobristLow[from][15&piece],g_hashKeyHigh^=g_zobristHigh[from][15&piece],g_hashKeyLow^=g_zobristLow[to][15&piece],g_hashKeyHigh^=g_zobristHigh[to][15&piece],g_hashKeyLow^=g_zobristBlackLow,g_hashKeyHigh^=g_zobristBlackHigh,g_castleRights&=g_castleRightsMask[from]&g_castleRightsMask[to],g_baseEval-=pieceSquareAdj[7&piece][0==me?flipTable[from]:from],g_pieceIndex[to]=g_pieceIndex[from],g_pieceList[(15&piece)<<4|g_pieceIndex[to]]=to,flags&moveflagPromotion){var newPiece=-8&piece;newPiece|=flags&moveflagPromoteKnight?pieceKnight:flags&moveflagPromoteQueen?pieceQueen:flags&moveflagPromoteBishop?pieceBishop:pieceRook,g_hashKeyLow^=g_zobristLow[to][15&piece],g_hashKeyHigh^=g_zobristHigh[to][15&piece],g_board[to]=newPiece,g_hashKeyLow^=g_zobristLow[to][15&newPiece],g_hashKeyHigh^=g_zobristHigh[to][15&newPiece],g_baseEval+=pieceSquareAdj[7&newPiece][0==me?flipTable[to]:to],g_baseEval-=materialTable[piecePawn],g_baseEval+=materialTable[7&newPiece];var pawnType=15&piece,promoteType=15&newPiece;g_pieceCount[pawnType]--;var lastPawnSquare=g_pieceList[pawnType<<4|g_pieceCount[pawnType]];g_pieceIndex[lastPawnSquare]=g_pieceIndex[to],g_pieceList[pawnType<<4|g_pieceIndex[lastPawnSquare]]=lastPawnSquare,g_pieceList[pawnType<<4|g_pieceCount[pawnType]]=0,g_pieceIndex[to]=g_pieceCount[promoteType],g_pieceList[promoteType<<4|g_pieceIndex[to]]=to,g_pieceCount[promoteType]++}else g_board[to]=g_board[from],g_baseEval+=pieceSquareAdj[7&piece][0==me?flipTable[to]:to];if(g_board[from]=pieceEmpty,g_toMove=otherColor,g_baseEval=-g_baseEval,(7&piece)==pieceKing||g_inCheck){if(IsSquareAttackable(g_pieceList[(pieceKing|8-g_toMove)<<4],otherColor))return UnmakeMove(move),!1}else{var kingPos=g_pieceList[(pieceKing|8-g_toMove)<<4];if(ExposesCheck(from,kingPos))return UnmakeMove(move),!1;if(epcEnd!=to&&ExposesCheck(epcEnd,kingPos))return UnmakeMove(move),!1}if(g_inCheck=!1,flags<=moveflagEPC){var theirKingPos=g_pieceList[(pieceKing|g_toMove)<<4];g_inCheck=IsSquareAttackableFrom(theirKingPos,to),g_inCheck||(g_inCheck=ExposesCheck(from,theirKingPos))||epcEnd!=to&&(g_inCheck=ExposesCheck(epcEnd,theirKingPos))}else g_inCheck=IsSquareAttackable(g_pieceList[(pieceKing|g_toMove)<<4],8-g_toMove);return g_repMoveStack[g_moveCount-1]=g_hashKeyLow,g_move50++,!0}function UnmakeMove(move){g_toMove=8-g_toMove,g_baseEval=-g_baseEval,g_moveCount--,g_enPassentSquare=g_moveUndoStack[g_moveCount].ep,g_castleRights=g_moveUndoStack[g_moveCount].castleRights,g_inCheck=g_moveUndoStack[g_moveCount].inCheck,g_baseEval=g_moveUndoStack[g_moveCount].baseEval,g_hashKeyLow=g_moveUndoStack[g_moveCount].hashKeyLow,g_hashKeyHigh=g_moveUndoStack[g_moveCount].hashKeyHigh,g_move50=g_moveUndoStack[g_moveCount].move50;var flags=16711680&move,captured=g_moveUndoStack[g_moveCount].captured,to=move>>8&255,from=255&move,piece=g_board[to];if(flags)if(flags&moveflagCastleKing){var rook=g_board[to-1];g_board[to+1]=rook,g_board[to-1]=pieceEmpty;var rookIndex=g_pieceIndex[to-1];g_pieceIndex[to+1]=rookIndex,g_pieceList[(15&rook)<<4|rookIndex]=to+1}else if(flags&moveflagCastleQueen){var rook=g_board[to+1];g_board[to-2]=rook,g_board[to+1]=pieceEmpty;var rookIndex=g_pieceIndex[to+1];g_pieceIndex[to-2]=rookIndex,g_pieceList[(15&rook)<<4|rookIndex]=to-2}if(flags&moveflagPromotion){piece=-8&g_board[to]|piecePawn,g_board[from]=piece;var pawnType=15&g_board[from],promoteType=15&g_board[to];g_pieceCount[promoteType]--;var lastPromoteSquare=g_pieceList[promoteType<<4|g_pieceCount[promoteType]];g_pieceIndex[lastPromoteSquare]=g_pieceIndex[to],g_pieceList[promoteType<<4|g_pieceIndex[lastPromoteSquare]]=lastPromoteSquare,g_pieceList[promoteType<<4|g_pieceCount[promoteType]]=0,g_pieceIndex[to]=g_pieceCount[pawnType],g_pieceList[pawnType<<4|g_pieceIndex[to]]=to,g_pieceCount[pawnType]++}else g_board[from]=g_board[to];var epcEnd=to;if(flags&moveflagEPC&&(epcEnd=g_toMove==colorWhite?to+16:to-16,g_board[to]=pieceEmpty),g_board[epcEnd]=captured,g_pieceIndex[from]=g_pieceIndex[to],g_pieceList[(15&piece)<<4|g_pieceIndex[from]]=from,captured){var captureType=15&captured;g_pieceIndex[epcEnd]=g_pieceCount[captureType],g_pieceList[captureType<<4|g_pieceCount[captureType]]=epcEnd,g_pieceCount[captureType]++}}function ExposesCheck(from,kingPos){var index=kingPos-from+128;if(0!=(g_vectorDelta[index].pieceMask[0]&1<<pieceQueen)){for(var delta=g_vectorDelta[index].delta,pos=kingPos+delta;0==g_board[pos];)pos+=delta;var piece=g_board[pos];if(0==(piece&(24^g_board[kingPos])&24))return!1;return 0!=(g_vectorDelta[pos-kingPos+128].pieceMask[piece>>3&1]&1<<(7&piece))}return!1}function IsSquareOnPieceLine(target,from){var index=from-target+128,piece=g_board[from];return!!(g_vectorDelta[index].pieceMask[piece>>3&1]&1<<(7&piece))}function IsSquareAttackableFrom(target,from){var index=from-target+128,piece=g_board[from];if(g_vectorDelta[index].pieceMask[piece>>3&1]&1<<(7&piece)){var inc=g_vectorDelta[index].delta;do{if((from+=inc)==target)return!0}while(0==g_board[from])}return!1}function IsSquareAttackable(target,color){var inc=color?-16:16,pawn=1|(color?colorWhite:colorBlack);if(g_board[target-(inc-1)]==pawn)return!0;if(g_board[target-(inc+1)]==pawn)return!0;for(var i=2;i<=6;i++)for(var index=(color|i)<<4,square=g_pieceList[index];0!=square;){if(IsSquareAttackableFrom(target,square))return!0;square=g_pieceList[++index]}return!1}function GenerateMove(from,to){return from|to<<8}function GenerateMove(from,to,flags){return from|to<<8|flags}function GenerateValidMoves(){var moveList=new Array,allMoves=new Array;GenerateCaptureMoves(allMoves,null),GenerateAllMoves(allMoves);for(var i=allMoves.length-1;i>=0;i--)MakeMove(allMoves[i])&&(moveList[moveList.length]=allMoves[i],UnmakeMove(allMoves[i]));return moveList}function GenerateAllMoves(moveStack){var from,to,pieceIdx;for(pieceIdx=(1|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;)GeneratePawnMoves(moveStack,from),from=g_pieceList[pieceIdx++];for(pieceIdx=(2|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;)to=from+31,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+33,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+14,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-14,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-31,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-33,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+18,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-18,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),from=g_pieceList[pieceIdx++];for(pieceIdx=(3|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;){for(to=from-15;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to-=15;for(to=from-17;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to-=17;for(to=from+15;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to+=15;for(to=from+17;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to+=17;from=g_pieceList[pieceIdx++]}for(pieceIdx=(4|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;){for(to=from-1;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to--;for(to=from+1;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to++;for(to=from+16;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to+=16;for(to=from-16;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to-=16;from=g_pieceList[pieceIdx++]}for(pieceIdx=(5|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;){for(to=from-15;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to-=15;for(to=from-17;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to-=17;for(to=from+15;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to+=15;for(to=from+17;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to+=17;for(to=from-1;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to--;for(to=from+1;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to++;for(to=from+16;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to+=16;for(to=from-16;0==g_board[to];)moveStack[moveStack.length]=GenerateMove(from,to),to-=16;from=g_pieceList[pieceIdx++]}if(pieceIdx=(6|g_toMove)<<4,from=g_pieceList[pieceIdx],to=from-15,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-17,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+15,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+17,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-1,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+1,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-16,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+16,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to)),!g_inCheck){var castleRights=g_castleRights;g_toMove||(castleRights>>=2),1&castleRights&&g_board[from+1]==pieceEmpty&&g_board[from+2]==pieceEmpty&&(moveStack[moveStack.length]=GenerateMove(from,from+2,moveflagCastleKing)),2&castleRights&&g_board[from-1]==pieceEmpty&&g_board[from-2]==pieceEmpty&&g_board[from-3]==pieceEmpty&&(moveStack[moveStack.length]=GenerateMove(from,from-2,moveflagCastleQueen))}}function GenerateCaptureMoves(moveStack,moveScores){var from,to,pieceIdx,inc=8==g_toMove?-16:16,enemy=8==g_toMove?16:8;for(pieceIdx=(1|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;)to=from+inc-1,g_board[to]&enemy&&MovePawnTo(moveStack,from,to),to=from+inc+1,g_board[to]&enemy&&MovePawnTo(moveStack,from,to),from=g_pieceList[pieceIdx++];if(-1!=g_enPassentSquare){var inc=g_toMove==colorWhite?-16:16,pawn=g_toMove|piecePawn,from=g_enPassentSquare-(inc+1);(15&g_board[from])==pawn&&(moveStack[moveStack.length]=GenerateMove(from,g_enPassentSquare,moveflagEPC)),from=g_enPassentSquare-(inc-1),(15&g_board[from])==pawn&&(moveStack[moveStack.length]=GenerateMove(from,g_enPassentSquare,moveflagEPC))}for(pieceIdx=(2|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;)to=from+31,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+33,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+14,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-14,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-31,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-33,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+18,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-18,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),from=g_pieceList[pieceIdx++];for(pieceIdx=(3|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;){to=from;do{to-=15}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to-=17}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to+=15}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to+=17}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),from=g_pieceList[pieceIdx++]}for(pieceIdx=(4|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;){to=from;do{to--}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to++}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to-=16}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to+=16}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),from=g_pieceList[pieceIdx++]}for(pieceIdx=(5|g_toMove)<<4,from=g_pieceList[pieceIdx++];0!=from;){to=from;do{to-=15}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to-=17}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to+=15}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to+=17}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to--}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to++}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to-=16}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from;do{to+=16}while(0==g_board[to]);g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),from=g_pieceList[pieceIdx++]}pieceIdx=(6|g_toMove)<<4,from=g_pieceList[pieceIdx],to=from-15,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-17,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+15,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+17,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-1,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+1,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from-16,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to)),to=from+16,g_board[to]&enemy&&(moveStack[moveStack.length]=GenerateMove(from,to))}function MovePawnTo(moveStack,start,square){var row=240&square;144==row||32==row?(moveStack[moveStack.length]=GenerateMove(start,square,moveflagPromotion|moveflagPromoteQueen),moveStack[moveStack.length]=GenerateMove(start,square,moveflagPromotion|moveflagPromoteKnight),moveStack[moveStack.length]=GenerateMove(start,square,moveflagPromotion|moveflagPromoteBishop),moveStack[moveStack.length]=GenerateMove(start,square,moveflagPromotion)):moveStack[moveStack.length]=GenerateMove(start,square,0)}function GeneratePawnMoves(moveStack,from){var piece=g_board[from],color=piece&colorWhite,inc=color==colorWhite?-16:16,to=from+inc;0==g_board[to]&&(MovePawnTo(moveStack,from,to,pieceEmpty),(48==(240&from)&&color!=colorWhite||128==(240&from)&&color==colorWhite)&&(to+=inc,0==g_board[to]&&(moveStack[moveStack.length]=GenerateMove(from,to))))}function UndoHistory(ep,castleRights,inCheck,baseEval,hashKeyLow,hashKeyHigh,move50,captured){this.ep=ep,this.castleRights=castleRights,this.inCheck=inCheck,this.baseEval=baseEval,this.hashKeyLow=hashKeyLow,this.hashKeyHigh=hashKeyHigh,this.move50=move50,this.captured=captured}function See(move){var from=255&move,to=move>>8&255,fromPiece=g_board[from],fromValue=g_seeValues[15&fromPiece],toValue=g_seeValues[15&g_board[to]];if(fromValue<=toValue)return!0;if(move>>16)return!0;var us=fromPiece&colorWhite?colorWhite:0,them=8-us,inc=fromPiece&colorWhite?-16:16;if((15&g_board[to+inc+1])==(piecePawn|them)||(15&g_board[to+inc-1])==(piecePawn|them))return!1;var themAttacks=new Array,captureDeficit=fromValue-toValue;if(SeeAddKnightAttacks(to,them,themAttacks),0!=themAttacks.length&&captureDeficit>g_seeValues[pieceKnight])return!1;g_board[from]=0;for(var pieceType=pieceBishop;pieceType<=pieceQueen;pieceType++)if(SeeAddSliderAttacks(to,them,themAttacks,pieceType)&&captureDeficit>g_seeValues[pieceType])return g_board[from]=fromPiece,!1;if((15&g_board[to-inc+1])==(piecePawn|us)||(15&g_board[to-inc-1])==(piecePawn|us))return g_board[from]=fromPiece,!0;SeeAddSliderAttacks(to,them,themAttacks,pieceKing);var usAttacks=new Array;SeeAddKnightAttacks(to,us,usAttacks);for(var pieceType=pieceBishop;pieceType<=pieceKing;pieceType++)SeeAddSliderAttacks(to,us,usAttacks,pieceType);g_board[from]=fromPiece;for(var seeValue=toValue-fromValue;;){for(var capturingPieceValue=1e3,capturingPieceIndex=-1,i=0;i<themAttacks.length;i++)if(0!=themAttacks[i]){var pieceValue=g_seeValues[7&g_board[themAttacks[i]]];pieceValue<capturingPieceValue&&(capturingPieceValue=pieceValue,capturingPieceIndex=i)}if(-1==capturingPieceIndex)return!0;if((seeValue+=capturingPieceValue)<0)return!1;var capturingPieceSquare=themAttacks[capturingPieceIndex];themAttacks[capturingPieceIndex]=0,SeeAddXrayAttack(to,capturingPieceSquare,us,usAttacks,themAttacks),capturingPieceValue=1e3,capturingPieceIndex=-1;for(var i=0;i<usAttacks.length;i++)if(0!=usAttacks[i]){var pieceValue=g_seeValues[7&g_board[usAttacks[i]]];pieceValue<capturingPieceValue&&(capturingPieceValue=pieceValue,capturingPieceIndex=i)}if(-1==capturingPieceIndex)return!1;if((seeValue-=capturingPieceValue)>=0)return!0;capturingPieceSquare=usAttacks[capturingPieceIndex],usAttacks[capturingPieceIndex]=0,SeeAddXrayAttack(to,capturingPieceSquare,us,usAttacks,themAttacks)}}function SeeAddXrayAttack(target,square,us,usAttacks,themAttacks){var index=square-target+128,delta=-g_vectorDelta[index].delta;if(0!=delta){for(square+=delta;0==g_board[square];)square+=delta;24&g_board[square]&&IsSquareOnPieceLine(target,square)&&((8&g_board[square])==us?usAttacks[usAttacks.length]=square:themAttacks[themAttacks.length]=square)}}function SeeAddKnightAttacks(target,us,attacks){for(var pieceIdx=(us|pieceKnight)<<4,attackerSq=g_pieceList[pieceIdx++];0!=attackerSq;)IsSquareOnPieceLine(target,attackerSq)&&(attacks[attacks.length]=attackerSq),attackerSq=g_pieceList[pieceIdx++]}function SeeAddSliderAttacks(target,us,attacks,pieceType){for(var pieceIdx=(us|pieceType)<<4,attackerSq=g_pieceList[pieceIdx++],hit=!1;0!=attackerSq;)IsSquareAttackableFrom(target,attackerSq)&&(attacks[attacks.length]=attackerSq,hit=!0),attackerSq=g_pieceList[pieceIdx++];return hit}function BuildPVMessage(bestMove,value,timeTaken,ply){var totalNodes=g_nodeCount+g_qNodeCount;return"Ply:"+ply+" Score:"+value+" Nodes:"+totalNodes+" NPS:"+(totalNodes/(timeTaken/1e3)|0)+" "+PVFromHash(bestMove,15)}function FinishPlyCallback(bestMove,value,timeTaken,ply){console.log(bestMove),postMessage("pv "+BuildPVMessage(bestMove,value,timeTaken,ply))}function PcIngeniesMove(move){var from=255&move,to=move>>8&255,sfrom=FormatSquare(from),sto=FormatSquare(to),move={from:sfrom,to:sto};postMessage(move)}var g_startTime,g_nodeCount,g_qNodeCount,g_searchValid,g_toMove,g_castleRights,g_enPassentSquare,g_baseEval,g_hashKeyLow,g_hashKeyHigh,g_inCheck,g_hashTable,g_killers,g_zobristLow,g_zobristHigh,g_zobristBlackLow,g_zobristBlackHigh,g_mobUnit,g_timeout=40,g_globalPly=0,minEval=-2e6,maxEval=2e6,minMateBuffer=minEval+2e3,maxMateBuffer=maxEval-2e3,materialTable=[0,800,3350,3450,5e3,9750,6e5],pawnAdj=[0,0,0,0,0,0,0,0,-25,105,135,270,270,135,105,-25,-80,0,30,176,176,30,0,-80,-85,-5,25,175,175,25,-5,-85,-90,-10,20,125,125,20,-10,-90,-95,-15,15,75,75,15,-15,-95,-100,-20,10,70,70,10,-20,-100,0,0,0,0,0,0,0,0],knightAdj=[-200,-100,-50,-50,-50,-50,-100,-200,-100,0,0,0,0,0,0,-100,-50,0,60,60,60,60,0,-50,-50,0,30,60,60,30,0,-50,-50,0,30,60,60,30,0,-50,-50,0,30,30,30,30,0,-50,-100,0,0,0,0,0,0,-100,-200,-50,-25,-25,-25,-25,-50,-200],bishopAdj=[-50,-50,-25,-10,-10,-25,-50,-50,-50,-25,-10,0,0,-10,-25,-50,-25,-10,0,25,25,0,-10,-25,-10,0,25,40,40,25,0,-10,-10,0,25,40,40,25,0,-10,-25,-10,0,25,25,0,-10,-25,-50,-25,-10,0,0,-10,-25,-50,-50,-50,-25,-10,-10,-25,-50,-50],rookAdj=[-60,-30,-10,20,20,-10,-30,-60,40,70,90,120,120,90,70,40,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60,-60,-30,-10,20,20,-10,-30,-60],kingAdj=[50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,50,150,-25,-125,-125,-25,150,50,150,250,75,-25,-25,75,250,150],emptyAdj=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],pieceSquareAdj=new Array(8),flipTable=new Array(256),colorBlack=16,colorWhite=8,pieceEmpty=0,piecePawn=1,pieceKnight=2,pieceBishop=3,pieceRook=4,pieceQueen=5,pieceKing=6,g_vectorDelta=new Array(256),g_bishopDeltas=[-15,-17,15,17],g_knightDeltas=[31,33,14,-14,-31,-33,18,-18],g_rookDeltas=[-1,1,-16,16],g_queenDeltas=[-1,1,-15,15,-17,17,-16,16],g_castleRightsMask=[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7,15,15,15,3,15,15,11,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,15,15,15,15,15,15,15,15,0,0,0,0,0,0,0,0,13,15,15,15,12,15,15,14,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],moveflagEPC=2<<16,moveflagCastleKing=4<<16,moveflagCastleQueen=8<<16,moveflagPromotion=16<<16,moveflagPromoteKnight=32<<16,moveflagPromoteQueen=64<<16,moveflagPromoteBishop=8388608,g_board=new Array(256),g_moveCount=0,g_moveUndoStack=new Array,g_move50=0,g_repMoveStack=new Array,g_hashSize=1<<22,g_hashMask=g_hashSize-1,historyTable=new Array(32),hashflagAlpha=1,hashflagBeta=2,hashflagExact=3,g_pieceIndex=new Array(256),g_pieceList=new Array(256),g_pieceCount=new Array(16),g_seeValues=[0,1,3,3,5,9,900,0,0,1,3,3,5,9,900,0],needsReset=!0;self.onmessage=function(e){if("go"!=e.data&&!needsReset||(ResetGame(),needsReset=!1,"go"!=e.data))if("position"==e.data.match("^position")){ResetGame();var result=InitializeFromFen(e.data.substr(9,e.data.length-9));0!=result.length&&postMessage("message "+result)}else"search"==e.data.match("^search")?(g_timeout=parseInt(e.data.substr(7,e.data.length-7),10),Search(PcIngeniesMove,99,null)):"analyze"==e.data?(g_timeout=99999999999,Search(null,99,FinishPlyCallback)):MakeMove(GetMoveFromString(e.data))}}]);